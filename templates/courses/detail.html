{% extends 'base.html' %}
{% load static i18n %}

{% block title %}{{ course.title }}{% endblock %}

{% block extra_css %}
<style>
    /* Modern Professional Courses Detail Design - Purple Theme */
    html, body { 
        background: #0a0a0a !important; 
        color: #e0e0e0 !important; 
    }
    
    .course-detail-wrap { 
        background: linear-gradient(180deg, #0a0a0a 0%, #1a1a1a 100%);
        padding: 80px 0 100px;
        min-height: 100vh;
    }
    
    /* Course Header */
    .course-header {
        background: linear-gradient(135deg, #161616 0%, #1f1f1f 100%);
        padding: 40px;
        border-radius: 20px;
        margin-bottom: 40px;
        border: 1px solid rgba(255,255,255,0.08);
        box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }
    
    .course-title {
        color: #ffffff;
        font-size: 42px;
        font-weight: 900;
        margin-bottom: 16px;
        line-height: 1.3;
        background: linear-gradient(135deg, #ffffff, #a855f7);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .course-description {
        color: #b0b0b0;
        font-size: 18px;
        line-height: 1.8;
        margin-bottom: 24px;
    }
    
    .course-description h2,
    .course-description h3,
    .course-description h4 {
        color: #ffffff;
        margin-top: 20px;
        margin-bottom: 15px;
        font-weight: 700;
    }
    
    .course-description h2 {
        font-size: 24px;
    }
    
    .course-description h3 {
        font-size: 20px;
    }
    
    .course-description p {
        margin-bottom: 15px;
        line-height: 1.8;
    }
    
    .course-description ul,
    .course-description ol {
        margin-right: 20px;
        margin-bottom: 15px;
        padding-right: 20px;
    }
    
    .course-description li {
        margin-bottom: 8px;
        line-height: 1.8;
    }
    
    .course-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        padding-top: 20px;
        border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    .course-meta-item {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #888;
        font-size: 14px;
    }
    
    .course-meta-item i {
        color: #a855f7;
        font-size: 16px;
    }
    
    /* Tabs */
    .course-tabs {
        background: #161616;
        border-radius: 16px;
        padding: 8px;
        margin-bottom: 30px;
        border: 1px solid rgba(255,255,255,0.08);
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    
    .course-tab {
        flex: 1;
        min-width: 120px;
        padding: 14px 24px;
        border-radius: 12px;
        text-decoration: none;
        color: #b0b0b0;
        font-weight: 600;
        text-align: center;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    .course-tab:hover {
        background: rgba(147,51,234,0.1);
        color: #a855f7;
        text-decoration: none;
    }
    
    .course-tab.active {
        background: linear-gradient(135deg, #9333ea, #a855f7);
        color: white;
        box-shadow: 0 4px 16px rgba(147,51,234,0.3);
    }
    
    .course-tab.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }
    
    /* Tab Content */
    .tab-content-wrapper {
        background: linear-gradient(135deg, #161616 0%, #1f1f1f 100%);
        padding: 40px;
        border-radius: 20px;
        border: 1px solid rgba(255,255,255,0.08);
        box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        min-height: 400px;
    }
    
    .tab-pane {
        display: none;
    }
    
    .tab-pane.active {
        display: block;
    }
    
    /* Videos Tab */
    .video-item {
        background: rgba(0,0,0,0.3);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        border: 1px solid rgba(255,255,255,0.08);
    }
    
    .video-item h4 {
        color: #ffffff;
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 12px;
    }
    
    .video-item p {
        color: #999;
        margin-bottom: 16px;
    }
    
    .video-wrapper {
        position: relative;
        width: 100%;
        padding-bottom: 56.25%;
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 16px;
    }
    
    .video-wrapper video,
    .video-wrapper iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    
    /* Quiz Tab */
    .quiz-container {
        max-width: 800px;
        margin: 0 auto;
    }
    
    .quiz-header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 30px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }
    
    .quiz-timer {
        background: linear-gradient(135deg, #9333ea, #a855f7);
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        text-align: center;
        font-size: 24px;
        font-weight: 700;
        box-shadow: 0 4px 16px rgba(147,51,234,0.3);
        flex: 1;
        min-width: 200px;
    }
    
    .circular-progress-container {
        position: relative;
        width: 120px;
        height: 120px;
    }
    
    .circular-progress {
        transform: rotate(-90deg);
    }
    
    .progress-ring-fill {
        transition: stroke-dashoffset 0.5s ease;
    }
    
    .progress-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #ffffff;
        font-size: 24px;
        font-weight: 700;
    }
    
    .progress-text span {
        color: #a855f7;
    }
    
    .quiz-timer.warning {
        background: linear-gradient(135deg, #f59e0b, #f97316);
    }
    
    .quiz-timer.danger {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    .quiz-progress {
        background: rgba(255,255,255,0.1);
        height: 8px;
        border-radius: 999px;
        margin-bottom: 30px;
        overflow: hidden;
    }
    
    .quiz-progress-bar {
        background: linear-gradient(90deg, #9333ea, #a855f7);
        height: 100%;
        transition: width 0.3s ease;
    }
    
    .question-card {
        background: rgba(0,0,0,0.3);
        border-radius: 16px;
        padding: 30px;
        margin-bottom: 24px;
        border: 1px solid rgba(255,255,255,0.08);
    }
    
    .question-number {
        color: #a855f7;
        font-size: 14px;
        font-weight: 700;
        margin-bottom: 12px;
    }
    
    .question-text {
        color: #ffffff;
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 24px;
        line-height: 1.6;
    }
    
    .quiz-options {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .quiz-option {
        background: rgba(255,255,255,0.05);
        border: 2px solid rgba(255,255,255,0.1);
        border-radius: 12px;
        padding: 16px 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .quiz-option:hover {
        background: rgba(147,51,234,0.1);
        border-color: rgba(147,51,234,0.3);
        transform: translateX(4px);
    }
    
    .quiz-option.selected {
        background: rgba(147,51,234,0.2);
        border-color: #a855f7;
        box-shadow: 0 4px 12px rgba(147,51,234,0.2);
    }
    
    .quiz-option input[type="radio"] {
        width: 20px;
        height: 20px;
        accent-color: #a855f7;
        cursor: pointer;
    }
    
    .quiz-option label {
        flex: 1;
        color: #e0e0e0;
        font-size: 16px;
        cursor: pointer;
        margin: 0;
    }
    
    .quiz-actions {
        display: flex;
        justify-content: space-between;
        gap: 16px;
        margin-top: 30px;
    }
    
    .quiz-btn {
        padding: 14px 32px;
        border-radius: 12px;
        font-weight: 700;
        font-size: 16px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .quiz-btn-primary {
        background: linear-gradient(135deg, #9333ea, #a855f7);
        color: white;
        box-shadow: 0 4px 16px rgba(147,51,234,0.3);
    }
    
    .quiz-btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(147,51,234,0.4);
    }
    
    .quiz-btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .quiz-btn-secondary {
        background: rgba(255,255,255,0.05);
        color: #b0b0b0;
        border: 1px solid rgba(255,255,255,0.1);
    }
    
    .quiz-btn-secondary:hover {
        background: rgba(255,255,255,0.1);
        color: #ffffff;
    }
    
    /* Success Tab */
    .success-content {
        text-align: center;
        padding: 60px 20px;
    }
    
    .success-icon {
        font-size: 80px;
        margin-bottom: 24px;
    }
    
    .success-title {
        color: #ffffff;
        font-size: 36px;
        font-weight: 900;
        margin-bottom: 16px;
    }
    
    .success-message {
        color: #b0b0b0;
        font-size: 18px;
        line-height: 1.8;
        margin-bottom: 30px;
    }
    
    .certificate-info {
        background: rgba(147,51,234,0.1);
        border: 2px solid rgba(147,51,234,0.3);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 30px;
    }
    
    .certificate-code {
        color: #a855f7;
        font-size: 24px;
        font-weight: 700;
        font-family: monospace;
        margin: 12px 0;
    }
    
    .success-btn {
        background: linear-gradient(135deg, #9333ea, #a855f7);
        color: white;
        padding: 16px 40px;
        border-radius: 12px;
        text-decoration: none;
        font-weight: 700;
        font-size: 16px;
        display: inline-block;
        box-shadow: 0 4px 16px rgba(147,51,234,0.3);
        transition: all 0.3s ease;
    }
    
    .success-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(147,51,234,0.4);
        color: white;
        text-decoration: none;
    }
    
    /* Alert Messages */
    .alert-box {
        background: rgba(239,68,68,0.1);
        border: 2px solid rgba(239,68,68,0.3);
        color: #fca5a5;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 24px;
    }
    
    .alert-box.success {
        background: rgba(34,197,94,0.1);
        border-color: rgba(34,197,94,0.3);
        color: #86efac;
    }
    
    .alert-box.warning {
        background: rgba(245,158,11,0.1);
        border-color: rgba(245,158,11,0.3);
        color: #fde047;
    }
    
    @media (max-width: 768px) {
        .course-title {
            font-size: 28px;
        }
        
        .course-tabs {
            flex-direction: column;
        }
        
        .course-tab {
            width: 100%;
        }
        
        .tab-content-wrapper {
            padding: 24px;
        }
        
        .quiz-actions {
            flex-direction: column;
        }
        
        .quiz-btn {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="course-detail-wrap">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <!-- Course Header -->
                <div class="course-header wow fadeInUp" data-wow-duration="1s" data-wow-delay=".2s">
                    <h1 class="course-title">{{ course.title }}</h1>
                    <div class="course-description">{{ course.description|safe }}</div>
                    <div class="course-meta">
                        <div class="course-meta-item">
                            <i class="fa fa-clock-o"></i>
                            <span>{% trans "Ø²Ù…Ø§Ù† Ø¢Ø²Ù…ÙˆÙ†:" %} {{ course.quiz_time_limit }} {% trans "Ø¯Ù‚ÛŒÙ‚Ù‡" %}</span>
                        </div>
                        <div class="course-meta-item">
                            <i class="fa fa-check-circle"></i>
                            <span>{% trans "Ø­Ø¯Ø§Ù‚Ù„ Ù†Ù…Ø±Ù‡ Ù‚Ø¨ÙˆÙ„ÛŒ:" %} {{ course.passing_score }}%</span>
                        </div>
                        <div class="course-meta-item">
                            <i class="fa fa-repeat"></i>
                            <span>{% trans "Ø­Ø¯Ø§Ú©Ø«Ø± ØªÙ„Ø§Ø´:" %} {{ course.max_attempts }}</span>
                        </div>
                        <div class="course-meta-item">
                            <i class="fa fa-video-camera"></i>
                            <span>{% trans "ØªØ¹Ø¯Ø§Ø¯ ÙˆÛŒØ¯ÛŒÙˆ:" %} {{ videos.count }}</span>
                        </div>
                        <div class="course-meta-item">
                            <i class="fa fa-question-circle"></i>
                            <span>{% trans "ØªØ¹Ø¯Ø§Ø¯ Ø³ÙˆØ§Ù„Ø§Øª:" %} {{ questions.count }}</span>
                        </div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="course-tabs wow fadeInUp" data-wow-duration="1s" data-wow-delay=".3s">
                    <a href="#videos" class="course-tab {% if active_tab == 'videos' %}active{% endif %} {% if quiz_in_progress %}disabled{% endif %}" data-tab="videos">
                        <i class="fa fa-video-camera"></i> {% trans "ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§" %}
                    </a>
                    <a href="#quiz" class="course-tab {% if active_tab == 'quiz' %}active{% endif %} {% if not can_take_quiz and not enrollment.passed %}disabled{% endif %}" data-tab="quiz">
                        <i class="fa fa-question-circle"></i> {% trans "Ø¢Ø²Ù…ÙˆÙ†" %}
                    </a>
                    <a href="#success" class="course-tab {% if active_tab == 'success' %}active{% endif %} {% if not enrollment.passed %}disabled{% endif %}" data-tab="success">
                        <i class="fa fa-trophy"></i> {% trans "Ù…ÙˆÙÙ‚ÛŒØª" %}
                    </a>
            </div>

                <!-- Tab Content -->
                <div class="tab-content-wrapper wow fadeInUp" data-wow-duration="1s" data-wow-delay=".4s">
                    <!-- Videos Tab -->
                    <div id="videos-tab" class="tab-pane {% if active_tab == 'videos' %}active{% endif %}">
                        <h3 style="color: #ffffff; font-size: 28px; font-weight: 800; margin-bottom: 30px;">
                            <i class="fa fa-video-camera" style="color: #a855f7; margin-left: 12px;"></i>
                            {% trans "ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ" %}
                        </h3>
                        {% if videos %}
                            {% for video in videos %}
                            <div class="video-item">
                                <h4>{{ video.title }}</h4>
                                {% if video.description %}
                                <p>{{ video.description }}</p>
                                {% endif %}
                                <div class="video-wrapper">
                                    {% if video.video_file %}
                                    <video controls preload="metadata" style="width:100%; height:100%;">
                                        <source src="{{ video.video_file.url }}" type="video/mp4">
                                    </video>
                                    {% elif video.video_url %}
                                    <iframe src="{{ video.video_url }}" frameborder="0" allowfullscreen style="width:100%; height:100%;"></iframe>
                        {% else %}
                                    <div style="display:flex; align-items:center; justify-content:center; height:100%; color:#666;">
                                        <div style="text-align:center;">
                                            <i class="fa fa-video-camera" style="font-size:48px; margin-bottom:12px;"></i>
                                            <p>{% trans "ÙˆÛŒØ¯ÛŒÙˆ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª" %}</p>
                                        </div>
                                        </div>
                                    {% endif %}
                                        </div>
                                {% if video.duration %}
                                <div style="color: #888; font-size: 14px;">
                                    <i class="fa fa-clock-o"></i> {% trans "Ù…Ø¯Øª Ø²Ù…Ø§Ù†:" %} {{ video.duration }}
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% else %}
                        <div style="text-align:center; padding:60px 20px; color:#666;">
                            <i class="fa fa-video-camera" style="font-size:64px; margin-bottom:20px; display:block;"></i>
                            <p>{% trans "ÙˆÛŒØ¯ÛŒÙˆÛŒÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª." %}</p>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Quiz Tab -->
                    <div id="quiz-tab" class="tab-pane {% if active_tab == 'quiz' %}active{% endif %}">
                        {% if not can_take_quiz and not enrollment.passed %}
                        <div class="alert-box">
                            <h4 style="margin-bottom:12px;"><i class="fa fa-exclamation-triangle"></i> {% trans "Ø§Ù…Ú©Ø§Ù† Ø´Ø±Ú©Øª Ø¯Ø± Ø¢Ø²Ù…ÙˆÙ† ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯" %}</h4>
                            {% if enrollment.attempts_used >= course.max_attempts %}
                            <p>{% trans "Ø´Ù…Ø§ ØªÙ…Ø§Ù… ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯. Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ù…Ø¯ÛŒØ± Ø³ÛŒØ³ØªÙ… ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯." %}</p>
                                {% else %}
                            <p>{% trans "Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø± Ø§ÛŒÙ† Ø¢Ø²Ù…ÙˆÙ† Ù‚Ø¨ÙˆÙ„ Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯." %}</p>
                                {% endif %}
                        </div>
                        {% elif questions.count == 0 %}
                        <div class="alert-box warning">
                            <p>{% trans "Ø³ÙˆØ§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¯ÙˆØ±Ù‡ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª." %}</p>
                        </div>
                        {% else %}
                        <div class="quiz-container">
                            <!-- Start Quiz Button -->
                            <div id="quizStartScreen" style="text-align:center; padding:60px 20px;">
                                <h3 style="color:#ffffff; font-size:28px; font-weight:800; margin-bottom:20px;">
                                    <i class="fa fa-question-circle" style="color:#a855f7; margin-left:12px;"></i>
                                    {% trans "Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø±ÙˆØ¹ Ø¢Ø²Ù…ÙˆÙ† Ù‡Ø³ØªÛŒØ¯ØŸ" %}
                                </h3>
                                <p style="color:#b0b0b0; font-size:16px; line-height:1.8; margin-bottom:30px; max-width:600px; margin-left:auto; margin-right:auto;">
                                    {% trans "Ø§ÛŒÙ† Ø¢Ø²Ù…ÙˆÙ† Ø´Ø§Ù…Ù„" %} {{ questions.count }} {% trans "Ø³ÙˆØ§Ù„ Ú†Ù†Ø¯Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ Ø§Ø³Øª Ùˆ" %} {{ course.quiz_time_limit }} {% trans "Ø¯Ù‚ÛŒÙ‚Ù‡ Ø²Ù…Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯. Ù¾Ø³ Ø§Ø² Ø´Ø±ÙˆØ¹ØŒ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ù‡ Ø³ÙˆØ§Ù„Ø§Øª Ù‚Ø¨Ù„ÛŒ Ø¨Ø±Ú¯Ø±Ø¯ÛŒØ¯." %}
                                </p>
                                <div style="background:rgba(147,51,234,0.1); border:2px solid rgba(147,51,234,0.3); border-radius:16px; padding:24px; margin-bottom:30px; max-width:500px; margin-left:auto; margin-right:auto;">
                                    <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
                                        <span style="color:#b0b0b0;">{% trans "Ø²Ù…Ø§Ù† Ø¢Ø²Ù…ÙˆÙ†:" %}</span>
                                        <span style="color:#ffffff; font-weight:700;">{{ course.quiz_time_limit }} {% trans "Ø¯Ù‚ÛŒÙ‚Ù‡" %}</span>
                                    </div>
                                    <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
                                        <span style="color:#b0b0b0;">{% trans "ØªØ¹Ø¯Ø§Ø¯ Ø³ÙˆØ§Ù„Ø§Øª:" %}</span>
                                        <span style="color:#ffffff; font-weight:700;">{{ questions.count }}</span>
                                    </div>
                                    <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
                                        <span style="color:#b0b0b0;">{% trans "Ø­Ø¯Ø§Ù‚Ù„ Ù†Ù…Ø±Ù‡ Ù‚Ø¨ÙˆÙ„ÛŒ:" %}</span>
                                        <span style="color:#ffffff; font-weight:700;">{{ course.passing_score }}%</span>
                                    </div>
                                    <div style="display:flex; justify-content:space-between;">
                                        <span style="color:#b0b0b0;">{% trans "ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡:" %}</span>
                                        <span style="color:#a855f7; font-weight:700;">{{ course.max_attempts|add:"-"|add:enrollment.attempts_used|default:course.max_attempts }}</span>
                                    </div>
                                </div>
                                <button class="quiz-btn quiz-btn-primary" id="startQuizBtn" style="font-size:18px; padding:18px 50px;">
                                    <i class="fa fa-play"></i> {% trans "Ø´Ø±ÙˆØ¹ Ø¢Ø²Ù…ÙˆÙ†" %}
                                </button>
                            </div>
                            
                            <!-- Quiz Content (Hidden Initially) -->
                            <div id="quizContent" style="display:none;">
                                <div class="quiz-header-section">
                                    <div class="quiz-timer" id="quizTimer">
                                        <i class="fa fa-clock-o"></i> <span id="timerDisplay">{{ course.quiz_time_limit }}:00</span>
                                    </div>
                                    <div class="circular-progress-container">
                                        <svg class="circular-progress" width="120" height="120">
                                            <circle class="progress-ring" cx="60" cy="60" r="54" fill="transparent" stroke="rgba(255,255,255,0.1)" stroke-width="8"/>
                                            <circle class="progress-ring-fill" cx="60" cy="60" r="54" fill="transparent" stroke="#a855f7" stroke-width="8" stroke-dasharray="339.292" stroke-dashoffset="339.292" stroke-linecap="round"/>
                                        </svg>
                                        <div class="progress-text">
                                            <span id="progressPercent">0</span>%
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="quizQuestions">
                                    <!-- Ø³ÙˆØ§Ù„Ø§Øª Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ù„ÙˆØ¯ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                                </div>
                                
                                <div class="quiz-actions" id="quizActions" style="display:none;">
                                    <button class="quiz-btn quiz-btn-secondary" id="prevQuestionBtn" style="display:none;">
                                        <i class="fa fa-arrow-right"></i> {% trans "Ù‚Ø¨Ù„ÛŒ" %}
                                    </button>
                                    <button class="quiz-btn quiz-btn-primary" id="nextQuestionBtn" style="display:none;">
                                        {% trans "Ø¨Ø¹Ø¯ÛŒ" %} <i class="fa fa-arrow-left"></i>
                                    </button>
                                    <button class="quiz-btn quiz-btn-primary" id="submitQuizBtn" style="display:none;">
                                        <i class="fa fa-check"></i> {% trans "Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§" %}
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Success Tab -->
                    <div id="success-tab" class="tab-pane {% if active_tab == 'success' %}active{% endif %}">
                                {% if enrollment.passed %}
                        <div class="success-content">
                            <div class="success-icon">ğŸ‰</div>
                            <h2 class="success-title">{% trans "ØªØ¨Ø±ÛŒÚ©! Ø´Ù…Ø§ Ù…ÙˆÙÙ‚ Ø´Ø¯ÛŒØ¯" %}</h2>
                            <p class="success-message">
                                {% trans "Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒÙ† Ø¯ÙˆØ±Ù‡ Ø±Ø§ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³Ø§Ù†Ø¯ÛŒØ¯ Ùˆ Ú¯ÙˆØ§Ù‡ÛŒÙ†Ø§Ù…Ù‡ Ø´Ù…Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª." %}
                            </p>
                            {% if enrollment.certificate_code %}
                            <div class="certificate-info">
                                <p style="color: #b0b0b0; margin-bottom:8px;">{% trans "Ú©Ø¯ Ú¯ÙˆØ§Ù‡ÛŒÙ†Ø§Ù…Ù‡ Ø´Ù…Ø§:" %}</p>
                                <div class="certificate-code">{{ enrollment.certificate_code }}</div>
                                <p style="color: #888; font-size:14px; margin-top:12px;">
                                    {% trans "Ú¯ÙˆØ§Ù‡ÛŒÙ†Ø§Ù…Ù‡ Ø´Ù…Ø§ Ø¯Ø± ØµÙØ­Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù‚Ø§Ø¨Ù„ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø§Ø³Øª." %}
                                </p>
                                                </div>
                                    {% endif %}
                            {% if last_completed_attempt %}
                            <div style="background:rgba(255,255,255,0.05); border-radius:12px; padding:20px; margin-bottom:30px;">
                                <p style="color:#b0b0b0; margin-bottom:8px;">{% trans "Ù†Ù…Ø±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ø´Ù…Ø§:" %}</p>
                                <p style="color:#a855f7; font-size:32px; font-weight:700;">
                                    {{ last_completed_attempt.percentage|floatformat:1 }}%
                                </p>
                                <p style="color:#888; font-size:14px; margin-top:8px;">
                                    {{ last_completed_attempt.score }} / {{ last_completed_attempt.total }} {% trans "Ø³ÙˆØ§Ù„ ØµØ­ÛŒØ­" %}
                                </p>
                            </div>
                            {% endif %}
                            <a href="{% url 'accounts:dashboard' %}" class="success-btn">
                                <i class="fa fa-user"></i> {% trans "Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú¯ÙˆØ§Ù‡ÛŒÙ†Ø§Ù…Ù‡ Ø¯Ø± Ù¾Ø±ÙˆÙØ§ÛŒÙ„" %}
                            </a>
                        </div>
                        {% else %}
                        <div class="alert-box">
                            <p>{% trans "Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² Ø§ÛŒÙ† Ø¯ÙˆØ±Ù‡ Ø±Ø§ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ù†Ø±Ø³Ø§Ù†Ø¯Ù‡â€ŒØ§ÛŒØ¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø¢Ø²Ù…ÙˆÙ† Ø±Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø§Ø³ Ú©Ù†ÛŒØ¯." %}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab Switching
    const tabs = document.querySelectorAll('.course-tab');
    const tabPanes = document.querySelectorAll('.tab-pane');
    
    // Track quiz state globally
    let quizInProgress = false;
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
            if (this.classList.contains('disabled')) {
                e.preventDefault();
                return;
            }
            
            const targetTab = this.getAttribute('data-tab');
            
            // Ø§Ú¯Ø± Ú©ÙˆÛŒÛŒØ² Ø´Ø±ÙˆØ¹ Ø´Ø¯Ù‡ Ùˆ Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡Ø¯ Ø¨Ù‡ ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§ Ø¨Ø±ÙˆØ¯ØŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ú©Ù†
            if (quizInProgress && targetTab === 'videos') {
                e.preventDefault();
                alert('Ø´Ù…Ø§ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¯Ø± Ø­ÛŒÙ† Ø¢Ø²Ù…ÙˆÙ† Ø¨Ù‡ ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø¢Ø²Ù…ÙˆÙ† Ø±Ø§ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø¨Ø±Ø³Ø§Ù†ÛŒØ¯.');
                return;
            }
            
            e.preventDefault();
            
            // Remove active class from all tabs and panes
            tabs.forEach(t => t.classList.remove('active'));
            tabPanes.forEach(p => p.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding pane
            this.classList.add('active');
            document.getElementById(targetTab + '-tab').classList.add('active');
            
            // Update URL
            const url = new URL(window.location);
            url.searchParams.set('tab', targetTab);
            window.history.pushState({}, '', url);
        });
    });
    
    // Quiz Functionality
    {% if active_tab == 'quiz' and can_take_quiz and questions.count > 0 %}
    const questions = [
        {% for question in questions %}
        {
            id: {{ question.id }},
            text: {{ question.text|escapejs }},
            options: [
                {% for option in question.options.all %}
                {
                    id: {{ option.id }},
                    text: {{ option.text|escapejs }},
                    is_correct: {{ option.is_correct|yesno:"true,false" }}
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ]
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    let currentQuestionIndex = 0;
    let answers = {};
    {% if current_attempt and current_attempt.answers %}
    try {
        answers = JSON.parse('{{ current_attempt.answers|escapejs }}');
    } catch(e) {
        answers = {};
    }
    {% endif %}
    let timeRemaining = {{ quiz_time_limit }} * 60; // seconds
    let timerInterval;
    let quizStarted = false;
    let quizActive = false;
    let nextBtnHandler = null;
    let quizInProgress = false;
    let nextBtnHandler = null;
    
    // Timer
    function updateTimer() {
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        document.getElementById('timerDisplay').textContent = 
            `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        const timerEl = document.getElementById('quizTimer');
        if (timeRemaining <= 60) {
            timerEl.classList.add('danger');
        } else if (timeRemaining <= 300) {
            timerEl.classList.add('warning');
        }
        
        if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            submitQuiz(true);
        }
        
        timeRemaining--;
    }
    
    function startTimer() {
        if (!quizStarted) {
            quizStarted = true;
            timerInterval = setInterval(updateTimer, 1000);
        }
    }
    
    // Update Circular Progress
    function updateCircularProgress(percentage) {
        const progressRing = document.querySelector('.progress-ring-fill');
        const progressText = document.getElementById('progressPercent');
        if (progressRing) {
            const circumference = 2 * Math.PI * 54; // r = 54
            const offset = circumference - (percentage / 100) * circumference;
            progressRing.style.strokeDashoffset = offset;
        }
        if (progressText) {
            progressText.textContent = Math.round(percentage);
        }
    }
    
    // Render Question
    function renderQuestion(index) {
        if (index < 0 || index >= questions.length) return;
        if (!quizActive) return;
        
        currentQuestionIndex = index;
        const question = questions[index];
        const savedAnswer = answers['question_' + question.id];
        
        const questionHtml = `
            <div class="question-card">
                <div class="question-number">Ø³ÙˆØ§Ù„ ${index + 1} Ø§Ø² ${questions.length}</div>
                <div class="question-text">${question.text}</div>
                <div class="quiz-options">
                    ${question.options.map((opt, optIndex) => {
                        const isSelected = savedAnswer == opt.id;
                        return `
                        <div class="quiz-option ${isSelected ? 'selected' : ''}" 
                             onclick="selectOption(${question.id}, ${opt.id}, this)">
                            <input type="radio" name="question_${question.id}" 
                                   id="opt_${opt.id}" value="${opt.id}" 
                                   ${isSelected ? 'checked' : ''}>
                            <label for="opt_${opt.id}">${opt.text}</label>
                        </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
        
        const quizQuestionsEl = document.getElementById('quizQuestions');
        if (quizQuestionsEl) {
            quizQuestionsEl.innerHTML = questionHtml;
        }
        
        // Update circular progress
        const progress = ((index + 1) / questions.length) * 100;
        updateCircularProgress(progress);
        
        // Update buttons
        const prevBtn = document.getElementById('prevQuestionBtn');
        const nextBtn = document.getElementById('nextQuestionBtn');
        const submitBtn = document.getElementById('submitQuizBtn');
        const actionsEl = document.getElementById('quizActions');
        
        if (prevBtn) prevBtn.style.display = 'none'; // Ù‚Ø¨Ù„ÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„
            if (nextBtn) {
            nextBtn.style.display = index < questions.length - 1 ? 'block' : 'none';
            // Ø­Ø°Ù event listener Ù‚Ø¨Ù„ÛŒ
            if (nextBtnHandler) {
                nextBtn.removeEventListener('click', nextBtnHandler);
            }
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† event listener Ø¬Ø¯ÛŒØ¯
            nextBtnHandler = function() {
                if (currentQuestionIndex < questions.length - 1) {
                    renderQuestion(currentQuestionIndex + 1);
                }
            };
            nextBtn.addEventListener('click', nextBtnHandler);
        }
        if (submitBtn) {
            submitBtn.style.display = index === questions.length - 1 ? 'block' : 'none';
        }
        if (actionsEl) actionsEl.style.display = 'flex';
        
        // Start timer on first question
        if (index === 0 && !quizStarted) {
            startTimer();
        }
    }
    
    // Select Option
    window.selectOption = function(questionId, optionId, element) {
        answers['question_' + questionId] = optionId;
        
        // Save answer to server
        fetch('{% url "courses:quiz_answer" slug=course.slug question_id=0 %}'.replace('0', questionId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `option_id=${optionId}`
        }).catch(err => console.error('Error saving answer:', err));
        
        // Update UI
        document.querySelectorAll('.quiz-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        if (element) {
            element.classList.add('selected');
            element.querySelector('input[type="radio"]').checked = true;
        }
    };
    
    // Navigation - Ø¨Ø§ÛŒØ¯ Ø¨Ø¹Ø¯ Ø§Ø² ØªØ¹Ø±ÛŒÙ renderQuestion Ø¨Ø§Ø´Ø¯
    // Ø§ÛŒÙ† event listener Ù‡Ø§ Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ÛŒ Ú©Ø¯ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
    
    // Submit Quiz
    function submitQuiz(timeUp = false) {
        if (timeUp) {
            alert('Ø²Ù…Ø§Ù† Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯! Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.');
        }
        
        clearInterval(timerInterval);
        
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "courses:quiz_submit" slug=course.slug %}';
        
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = '{{ csrf_token }}';
        form.appendChild(csrfInput);
        
        const timeInput = document.createElement('input');
        timeInput.type = 'hidden';
        timeInput.name = 'time_taken';
        timeInput.value = {{ quiz_time_limit }} * 60 - timeRemaining;
        form.appendChild(timeInput);
        
        document.body.appendChild(form);
        form.submit();
    }
    
    // Submit button handler
    const submitBtn = document.getElementById('submitQuizBtn');
    if (submitBtn) {
        submitBtn.addEventListener('click', function() {
            if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯ØŸ')) {
                submitQuiz();
            }
        });
    }
    
    // Start Quiz Button
    const startBtn = document.getElementById('startQuizBtn');
    const startScreen = document.getElementById('quizStartScreen');
    const quizContent = document.getElementById('quizContent');
    
    if (startBtn && startScreen && quizContent) {
        startBtn.addEventListener('click', function() {
            // Hide start screen
            startScreen.style.display = 'none';
            // Show quiz content
            quizContent.style.display = 'block';
            // Set quiz as active
            quizActive = true;
            quizInProgress = true;
            // Disable videos tab
            const videosTab = document.querySelector('.course-tab[data-tab="videos"]');
            if (videosTab) {
                videosTab.classList.add('disabled');
            }
            // Render first question
            renderQuestion(0);
        });
    } else if (quizContent && quizContent.style.display !== 'none') {
        // Ø§Ú¯Ø± Ø¯Ú©Ù…Ù‡ Ø§Ø³ØªØ§Ø±Øª Ù†ÛŒØ³ØªØŒ ÛŒØ¹Ù†ÛŒ Ù‚Ø¨Ù„Ø§Ù‹ Ø´Ø±ÙˆØ¹ Ø´Ø¯Ù‡
        quizActive = true;
        quizInProgress = true;
        // Disable videos tab
        const videosTab = document.querySelector('.course-tab[data-tab="videos"]');
        if (videosTab) {
            videosTab.classList.add('disabled');
        }
        renderQuestion(0);
    }
    
    // Tab switching - disable videos tab if quiz in progress
    tabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
            if (this.classList.contains('disabled')) {
                e.preventDefault();
                return;
            }
            
            const targetTab = this.getAttribute('data-tab');
            
            // Ø§Ú¯Ø± Ú©ÙˆÛŒÛŒØ² Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù… Ø§Ø³Øª Ùˆ Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡Ø¯ Ø¨Ù‡ ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§ Ø¨Ø±ÙˆØ¯ØŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ú©Ù†
            if (quizInProgress && targetTab === 'videos') {
                e.preventDefault();
                alert('Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù… Ø¢Ø²Ù…ÙˆÙ† Ù‡Ø³ØªÛŒØ¯. Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ù‡ ØªØ¨ ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§ Ø¨Ø±ÙˆÛŒØ¯.');
                return;
            }
            
            e.preventDefault();
            
            // Remove active class from all tabs and panes
            tabs.forEach(t => t.classList.remove('active'));
            tabPanes.forEach(p => p.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding pane
            this.classList.add('active');
            document.getElementById(targetTab + '-tab').classList.add('active');
            
            // Update URL
            const url = new URL(window.location);
            url.searchParams.set('tab', targetTab);
            window.history.pushState({}, '', url);
        });
    });
    {% endif %}
});
</script>
{% endblock %}
